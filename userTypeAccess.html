<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Type Changed</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6fa;
        margin: 0;
        padding: 40px;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
      .user-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .user-info {
        flex: 1;
      }
      .user-info h2 {
        margin: 0 0 6px;
        color: #333;
      }
      .user-info p {
        margin: 0;
        color: #666;
      }
      .action-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: white;
        text-decoration: none;
        transition: 0.3s;
      }
      .action-btn:hover {
        opacity: 0.85;
      }
      .host-btn {
        background: #007bff;
      }
    </style>
  </head>
  <body>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <nav id="navbar" class="sticky top-0 z-40"></nav>
    <main class="max-w-4xl mx-auto px-4 py-10">
      <h1 class="text-3xl font-extrabold mb-6">All Users</h1>
      <div id="userList" class="space-y-4"></div>
    </main>

    <script type="module">
      import { getUserSession } from "./assets/js/services.js";

      async function checkAccess() {
        try {
          const data = await getUserSession();
          if (!data?.user || data.user.userType !== "host") {
            window.location.href = "/unauthorsisedAccess";
          }
        } catch (error) {
          window.location.href = "/unauthorsisedAccess"; // fallback redirect
        }
      }

      document.addEventListener("DOMContentLoaded", checkAccess);
    </script>
    <script type="module" src="./assets/js/DynamicNav.js"></script>
    <script type="module">
      import { getUsers, userTypeChanged } from "./assets/js/services.js";

      // === Extract query params from URL ===
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id"),
          needChange: params.get("needChange") === "true",
          type: params.get("type"),
        };
      }

      // === Main initialization ===
      async function init() {
        try {
          const { id, needChange, type } = getQueryParams();

          // ✅ If URL includes a change request, handle type update first
          if (needChange && id && type) {
            try {
              const response = await userTypeChanged({ id, changeType: type });
              if (response.status) {
                alert("User type changed successfully!");
                window.location.href = "/typeChange"; // reload list
              } else {
                alert(response.message || "Failed to change user type");
              }
            } catch (err) {}
            return; // stop here after handling update
          }

          // ✅ Otherwise, show user list
          const users = await getUsers();
          const container = document.getElementById("userList");
          container.innerHTML = "";

          users.forEach((user) => {
            const card = document.createElement("div");
            card.className = "user-card";

            card.innerHTML = `
          <div class="user-info">
            <h2>${user.userName}</h2>
            <p>${user.email}</p>
          </div>
          <div>
            <a href="/typeChange?id=${user._id}&type=${
              user.userType === "guest" ? "host" : "guest"
            }&needChange=true"
               class="action-btn host-btn">
              ${user.userType === "guest" ? "Switch to Host" : "Switch to User"}
            </a>
          </div>
        `;

            container.appendChild(card);
          });
        } catch (err) {}
      }

      init();
    </script>
  </body>
</html>
