<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking History</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <nav id="navbar" class="sticky top-0 z-40"></nav>
    <main class="max-w-5xl mx-auto px-4 py-10">
      <h1 class="text-3xl font-extrabold mb-6 text-center">Booking History</h1>

      <div class="flex justify-center gap-4 mb-6">
        <button id="packageBtn" class="px-4 py-2 bg-sky-600 text-white rounded-md">ğŸ“¦ Package Booking History</button>
        <button id="carBtn" class="px-4 py-2 bg-slate-200 rounded-md">ğŸš— Car Rent Booking History</button>
      </div>

      <div id="bookingList" class="bg-white rounded-lg shadow p-6">Loading booking data...</div>

      <script type="module" src="./assets/js/DynamicNav.js"></script>
  <script type="module">
  import { getUsers } from './assets/js/services.js';

  const packageBtn = document.getElementById("packageBtn");
  const carBtn = document.getElementById("carBtn");
  const bookingList = document.getElementById("bookingList");

  let usersData = [];

  // === Fetch all users once ===
  async function loadUsers() {
    try {
      const data = await getUsers();
      if (data.error) {
        bookingList.innerHTML = `<p class="no-data">Error loading users: ${data.message}</p>`;
        return;
      }
      usersData = data.users || data;

      renderBookings("package"); // default view
    } catch (err) {
      bookingList.innerHTML = `<p class="no-data">Error loading users.</p>`;
      
    }
  }

  // === Render bookings based on selected type ===
  function renderBookings(type) {
    bookingList.innerHTML = "";

    const usersWithBookings = usersData.filter(user =>
      type === "package" ? user.packageBook?.length : user.carBooking?.length
    );

    if (usersWithBookings.length === 0) {
      bookingList.innerHTML = `<p class="no-data">No ${type === "package" ? "Package" : "Car Rent"} bookings found.</p>`;
      return;
    }

    usersWithBookings.forEach(user => {
      const userBlock = document.createElement("div");
      userBlock.className = "user-block";

      let bookingsHTML = "";

      if (type === "package") {
        // Sort package bookings by bookingDate (latest first)
        const sortedPackage = [...user.packageBook].sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));

        bookingsHTML = sortedPackage.map(b => `
          <div class="booking-item">
            ğŸ“¦ <strong>${b.packageName}</strong> |
            Date: ${new Date(b.bookingDate).toLocaleString()}
          </div>
        `).join("");
      } else {
        // Sort car bookings by bookingDate (latest first)
        const sortedCar = [...user.carBooking].sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));

        bookingsHTML = sortedCar.map(b => `
          <div class="booking-item">
            ğŸš— <strong>${b.carName}</strong> | Duration: ${b.duration} hrs |
            Date: ${new Date(b.bookingDate).toLocaleString()}
          </div>
        `).join("");
      }

      userBlock.innerHTML = `
        <div class="user-header">
          ğŸ‘¤ ${user.userName} | ğŸ“ ${user.phone} | âœ‰ï¸ ${user.email}
        </div>
        ${bookingsHTML}
      `;

      bookingList.appendChild(userBlock);
    });
  }

  // === Button Event Listeners ===
  packageBtn.addEventListener("click", () => {
    packageBtn.classList.add("active");
    carBtn.classList.remove("active");
    renderBookings("package");
  });

  carBtn.addEventListener("click", () => {
    carBtn.classList.add("active");
    packageBtn.classList.remove("active");
    renderBookings("car");
  });

  // === Initialize ===
  loadUsers();
</script>

</body>
</html>
